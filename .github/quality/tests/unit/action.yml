name: Unit tests - Code coverage
description: Check the code coverage of a project

runs:
  using: composite
  steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: "21"
        distribution: "temurin"

    - name: Run unit tests
      id: unit-tests
      run: |
        echo 'result<<EOF' >> $GITHUB_OUTPUT
        mvn test >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT
      shell: bash

    - name: Check code coverage
      id: coverage
      run: |
        mvn jacoco:report
        mvn jacoco:check
      shell: bash

    - name: Upload code coverage report
      uses: actions/upload-artifact@v2
      with:
        name: coverage-report

    - name: Comment PR
      id: comment
      uses: actions/github-script@v4
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          github.issues.createComment({
            issue_number: ${{ github.event.number }},
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `
              Test Covarage: ${{ steps.coverage.outputs.covered }}%

              \`\`\`
              ${{ steps.unit-tests.outputs.result }}
              \`\`\`

              Test Report salvo no GitHub Artifacts.
            `
          })
